<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pirates Trig - Capit√°n de Mando</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Rajdhani:wght@500;700;900&display=swap" rel="stylesheet">
  <style>
    :root { --bg-dark:#0f172a; --panel-bg:#1e293b; --neon-gold:#fbbf24; --neon-blue:#38bdf8; --neon-red:#f43f5e; --neon-green:#34d399; --neon-purple:#a855f7; --font-title:"Bangers", cursive; --font-body:"Rajdhani", sans-serif; }
    *{ box-sizing:border-box; }
    body{ background-color:var(--bg-dark); color:white; font-family:var(--font-body); margin:0; padding:20px; height:100vh; display:flex; flex-direction:column; }
    header{ display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid var(--neon-blue); padding-bottom:15px; margin-bottom:20px; gap:12px; }
    h1{ font-family:var(--font-title); color:var(--neon-gold); font-size:42px; margin:0; letter-spacing:2px; }
    .room-display{ font-size:32px; font-weight:900; color:var(--neon-blue); background:rgba(56,189,248,0.1); padding:5px 20px; border-radius:12px; border:1px solid var(--neon-blue); white-space:nowrap; }
    .controls{ display:flex; gap:15px; flex-wrap:wrap; justify-content:flex-end; }
    button{ font-family:var(--font-body); font-weight:900; font-size:18px; text-transform:uppercase; padding:12px 24px; border:none; border-radius:8px; cursor:pointer; transition:all 0.2s; }
    .btn-create{ background:var(--neon-gold); color:black; }
    .btn-start{ background:var(--neon-green); color:black; }
    .btn-reset{ background:var(--neon-red); color:white; }
    .btn-approve{ padding:5px 10px; font-size:12px; background:var(--neon-blue); color:black; }
    .btn-kraken{ background:var(--neon-purple); color:white; font-size:24px; padding: 5px 20px; border: 2px solid #fff; box-shadow: 0 0 10px var(--neon-purple); }
    .btn-kraken:active { transform: scale(0.95); }
    button:disabled{ opacity:0.5; cursor:not-allowed; filter:grayscale(1); }
    button:hover:not(:disabled){ transform:scale(1.05); }
    .main-area{ display:grid; grid-template-columns:300px 1fr; gap:20px; flex:1; overflow:hidden; }
    .sidebar{ background:var(--panel-bg); border-radius:12px; padding:15px; overflow-y:auto; border:1px solid #334155; }
    .sidebar h2{ color:#94a3b8; margin-top:0; font-size:20px; text-transform:uppercase; }
    .pending-item{ background:rgba(0,0,0,0.3); padding:10px; margin-bottom:8px; border-radius:8px; border-left:4px solid #64748b; display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .race-track{ background:var(--panel-bg); border-radius:12px; padding:20px; overflow-y:auto; border:1px solid #334155; display:flex; flex-direction:column; gap:15px; }
    .team-row{ background:rgba(15, 23, 42, 0.6); border-radius:10px; padding:15px; display:flex; align-items:center; gap:15px; border:1px solid rgba(255,255,255,0.05); position:relative; transition:all 0.3s ease; }
    .team-info{ width:220px; }
    .team-name{ font-weight:900; font-size:20px; display:block; }
    .team-members{ font-size:14px; color:#94a3b8; }
    .team-status{ font-size:24px; width:40px; text-align:center; }
    .progress-container{ flex:1; height:30px; background:rgba(0,0,0,0.5); border-radius:15px; position:relative; overflow:hidden; border:1px solid rgba(255,255,255,0.1); }
    .progress-fill{ height:100%; background:linear-gradient(90deg, var(--neon-blue), var(--neon-green)); width:0%; transition:width 0.5s ease-out; border-radius:15px; position:relative; }
    .progress-fill::after{ content:"‚õµ"; position:absolute; right:-10px; top:-4px; font-size:24px; filter:drop-shadow(0 0 5px black); }
    .progress-text{ position:absolute; right:10px; top:50%; transform:translateY(-50%); font-weight:bold; font-size:14px; color:white; text-shadow:0 1px 2px black; z-index:2; }
    .team-row.dead{ opacity:0.5; filter:grayscale(1); border-color:var(--neon-red); }
    .team-row.dead .progress-fill{ background:var(--neon-red); }
    .team-row.dead .progress-fill::after{ content:"‚ò†Ô∏è"; }
    .team-row.winner{ border:2px solid var(--neon-gold); background:rgba(251, 191, 36, 0.1); }
    .team-row.winner .progress-fill::after{ content:"üëë"; }
    #podiumModal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:100; align-items:center; justify-content:center; padding:20px; }
    .podium-card{ width:min(900px, 96vw); background:#0b1224; border:1px solid rgba(56,189,248,0.35); border-radius:18px; padding:18px; box-shadow:0 0 30px rgba(0,0,0,0.5); }
    .podium-title{ font-family:var(--font-title); color:var(--neon-gold); font-size:54px; letter-spacing:2px; margin:0 0 8px 0; }
    .podium-sub{ color:#94a3b8; margin:0 0 16px 0; }
    .podium-grid{ display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; margin:12px 0 16px; }
    .podium-slot{ background:rgba(30,41,59,0.55); border:1px solid rgba(255,255,255,0.08); border-radius:14px; padding:12px; min-height:110px; }
    .podium-medal{ font-size:34px; margin-bottom:4px; }
    .podium-team{ font-size:20px; font-weight:900; margin:0; }
    .podium-members{ color:#94a3b8; margin:6px 0 0 0; font-size:14px; line-height:1.2; word-break:break-word; }
    .podium-actions{ display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap; }
    .btn-blue{ background:var(--neon-blue); color:black; }
    @media (max-width: 900px){ .main-area{ grid-template-columns:1fr; } .team-info{ width:190px; } .podium-grid{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <header>
    <div><h1>PANEL DEL MAESTRO</h1><div style="color:#94a3b8; font-size:14px;">Monitor de Progreso (30 Preguntas)</div></div>
    <div id="roomDisplay" class="room-display" style="display:none;">---</div>
    <div class="controls">
      <button id="createBtn" class="btn-create">Crear Sala</button>
      <button id="btnKraken" class="btn-kraken" disabled title="Enviar Kraken Aleatorio">üêô</button>
      <button id="startBtn" class="btn-start" disabled>Iniciar Carrera</button>
      <button id="resetBtn" class="btn-reset" disabled>Terminar</button>
    </div>
  </header>
  <div class="main-area">
    <div class="sidebar"><h2>‚è≥ En Espera (<span id="pendingCount">0</span>)</h2><div id="pendingList"></div></div>
    <div class="race-track" id="raceTrack"><div style="text-align:center; color:#64748b; margin-top:50px;">La carrera aparecer√° aqu√≠ cuando se creen los equipos.</div></div>
  </div>
  <div id="podiumModal">
    <div class="podium-card">
      <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;">
        <div><h2 class="podium-title">PODIUM</h2><p class="podium-sub" id="podiumSub">Partida finalizada.</p></div>
        <div class="podium-actions"><button id="newGameBtn" class="btn-blue">Nueva Partida</button></div>
      </div>
      <div class="podium-grid">
        <div class="podium-slot" id="slot1"><div class="podium-medal">ü•á</div><p class="podium-team" id="p1Team">‚Äî</p><p class="podium-members" id="p1Members"></p></div>
        <div class="podium-slot" id="slot2"><div class="podium-medal">ü•à</div><p class="podium-team" id="p2Team">‚Äî</p><p class="podium-members" id="p2Members"></p></div>
        <div class="podium-slot" id="slot3"><div class="podium-medal">ü•â</div><p class="podium-team" id="p3Team">‚Äî</p><p class="podium-members" id="p3Members"></p></div>
      </div>
      <div style="color:#94a3b8; font-size:14px; margin-top:6px;">Nota: el cierre bloqueado 10s es para el PLAYER (alumno). Aqu√≠ el maestro solo visualiza el resultado.</div>
    </div>
  </div>
  <script src="./firebase-config.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getDatabase, ref, set, update, onValue, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    if (!window.FIREBASE_CONFIG) { alert("Falta firebase-config.js"); throw new Error("Missing config"); }
    const TOTAL_QUESTIONS = 30;
    const app = initializeApp(window.FIREBASE_CONFIG);
    const db = getDatabase(app);
    const auth = getAuth(app);
    let roomCode = null; let roomStatus = "lobby"; let approvedCount = 0; let finalized = false; let lastTeamsObj = {}; 
    const els = {
      createBtn: document.getElementById("createBtn"), startBtn: document.getElementById("startBtn"), resetBtn: document.getElementById("resetBtn"), btnKraken: document.getElementById("btnKraken"), roomDisplay: document.getElementById("roomDisplay"), pendingList: document.getElementById("pendingList"), pendingCount: document.getElementById("pendingCount"), raceTrack: document.getElementById("raceTrack"), podiumModal: document.getElementById("podiumModal"), podiumSub: document.getElementById("podiumSub"), p1Team: document.getElementById("p1Team"), p2Team: document.getElementById("p2Team"), p3Team: document.getElementById("p3Team"), p1Members: document.getElementById("p1Members"), p2Members: document.getElementById("p2Members"), p3Members: document.getElementById("p3Members"), newGameBtn: document.getElementById("newGameBtn")
    };

    signInAnonymously(auth).then(() => { const saved = localStorage.getItem("teacher_room"); if (saved) { roomCode = saved; initRoomListeners(); } });

    els.createBtn.onclick = async () => {
      roomCode = generateRoomCode(); localStorage.setItem("teacher_room", roomCode);
      await set(ref(db, `rooms/${roomCode}`), { status: "lobby", createdAt: serverTimestamp(), nextTeamIndex: 0, nextFinishRank: 1 });
      initRoomListeners();
    };
    els.startBtn.onclick = () => { if (!roomCode) return; if ((roomStatus === "lobby") && (approvedCount > 0)) update(ref(db, `rooms/${roomCode}`), { status: "running" }); };
    els.resetBtn.onclick = () => { if (!roomCode) return; if (confirm("¬øTerminar partida?")) { update(ref(db, `rooms/${roomCode}`), { status: "finished", podiumAt: serverTimestamp() }); localStorage.removeItem("teacher_room"); setTimeout(() => location.reload(), 700); } };
    els.btnKraken.onclick = () => {
      if (!roomCode || roomStatus !== 'running') return;
      const teams = Object.entries(lastTeamsObj).map(([id, t]) => ({id, ...t})).filter(t => t.approved && t.status !== 'dead');
      if(teams.length === 0) { alert("No hay equipos activos."); return; }
      teams.sort((a, b) => (Number(b.progress||0) - Number(a.progress||0)));
      const top3 = teams.slice(0, 3); const others = teams.slice(3);
      let victim = null; const roll = Math.random();
      if (roll < 0.8 && top3.length > 0) victim = top3[Math.floor(Math.random() * top3.length)];
      else if (others.length > 0) victim = others[Math.floor(Math.random() * others.length)];
      else victim = top3[Math.floor(Math.random() * top3.length)];

      if (victim) {
        const ms = Date.now();
        // AQUI ESTA LA MAGIA: Enviamos "krakenHit" para que el alumno sepa que es el Kraken
        update(ref(db, `rooms/${roomCode}/teams/${victim.id}/effects`), { frozenUntil: ms + 10000, krakenHit: ms }).then(() => {
          const prev = els.btnKraken.innerText; els.btnKraken.innerText = `üêô -> ${victim.teamName}`; setTimeout(() => els.btnKraken.innerText = "üêô", 2000);
        });
      }
    };
    els.newGameBtn.onclick = () => { localStorage.removeItem("teacher_room"); location.reload(); };

    function initRoomListeners() {
      els.createBtn.style.display = "none"; els.roomDisplay.textContent = roomCode; els.roomDisplay.style.display = "block"; els.resetBtn.disabled = false;
      onValue(ref(db, `rooms/${roomCode}/status`), (snap) => {
        roomStatus = snap.val() || "lobby";
        if (roomStatus === "running") { els.startBtn.disabled = true; els.startBtn.textContent = "EN CURSO..."; els.btnKraken.disabled = false; els.btnKraken.style.opacity = "1"; }
        else if (roomStatus === "finished") { els.startBtn.disabled = true; els.startBtn.textContent = "FINALIZADO"; els.btnKraken.disabled = true; showPodiumFromTeams(lastTeamsObj); }
        else { els.startBtn.textContent = "Iniciar Carrera"; els.startBtn.disabled = !(approvedCount > 0); els.btnKraken.disabled = true; els.btnKraken.style.opacity = "0.5"; }
      });
      onValue(ref(db, `rooms/${roomCode}/teams`), (snap) => {
        const teams = snap.val() || {}; lastTeamsObj = teams; approvedCount = Object.values(teams).filter(t => t && t.approved).length;
        if(roomStatus === 'lobby') els.startBtn.disabled = !(approvedCount > 0);
        renderDashboard(teams);
      });
      onValue(ref(db, `rooms/${roomCode}/podiumAt`), (snap) => { if (snap.val() && roomStatus === "finished") showPodiumFromTeams(lastTeamsObj); });
    }

    function renderDashboard(teamsObj) {
      const teams = Object.entries(teamsObj).map(([key, val]) => ({ id: key, ...val }));
      const pending = teams.filter(t => !t.approved);
      els.pendingCount.textContent = pending.length; els.pendingList.innerHTML = "";
      pending.forEach(t => {
        const div = document.createElement("div"); div.className = "pending-item";
        div.innerHTML = `<div><strong>${escapeHtml(t.teamName)}</strong><br><small>${escapeHtml((t.members||[]).join(", "))}</small></div>`;
        const btn = document.createElement("button"); btn.className = "btn-approve"; btn.textContent = "APROBAR"; btn.disabled = (roomStatus !== "lobby"); btn.onclick = () => approveTeam(t.id);
        div.appendChild(btn); els.pendingList.appendChild(div);
      });
      const active = teams.filter(t => t.approved).sort((a, b) => (Number(b.progress||0) - Number(a.progress||0)));
      if (active.length === 0) { els.raceTrack.innerHTML = '<div style="text-align:center; color:#64748b;">Esperando equipos...</div>'; return; }
      els.raceTrack.innerHTML = "";
      active.forEach(t => {
        const progress = Math.min(TOTAL_QUESTIONS, Math.max(0, Number(t.progress||0)));
        const percent = (progress / TOTAL_QUESTIONS) * 100;
        const isDead = (t.status === "dead"); const hasFinished = progress >= TOTAL_QUESTIONS;
        if (hasFinished && !t.finishRank && roomStatus === "running") assignFinishRankIfNeeded(t).catch(console.error);
        const now = Date.now(); const eff = t.effects || {};
        const rank = Number(t.finishRank||0);
        let icon = "";
        if (isDead) icon = "üíÄ"; else if (hasFinished) icon = "üëë"; else if ((eff.repairUntil||0) > now) icon = "üîß"; else if ((eff.frozenUntil||0) > now) icon = "‚ùÑÔ∏è"; else if ((eff.shieldUntil||0) > now) icon = "üõ°Ô∏è";
        const color = t.color ? "#" + t.color.toString(16).padStart(6, "0") : "#ffffff";
        const row = document.createElement("div"); row.className = `team-row ${isDead?"dead":""} ${hasFinished?"winner":""}`;
        row.innerHTML = `<div class="team-status">${icon}</div><div class="team-info"><span class="team-name" style="color:${color}">${rank>0?(rank===1?"ü•á ":rank===2?"ü•à ":rank===3?"ü•â ":""):""}${escapeHtml(t.teamName)}${rank>0?` <span style="color:#94a3b8;font-size:14px">(#${rank})</span>`:""}</span><span class="team-members">${escapeHtml((t.members||[]).join(", "))}</span><div style="font-size:12px;color:#64748b;margin-top:4px">Vidas: ${"‚ù§Ô∏è".repeat(t.lives??3)}${(t.lives??3)===0?" (0)":""}</div></div><div class="progress-container"><div class="progress-fill" style="width:${percent}%;"></div><div class="progress-text">${progress} / ${TOTAL_QUESTIONS}</div></div>`;
        els.raceTrack.appendChild(row);
      });
      if (roomStatus === "running" && !finalized) {
        const finishedCount = active.filter(t => (t.progress||0) >= TOTAL_QUESTIONS).length;
        if (active.length > 0 && finishedCount === active.length) { finalized = true; update(ref(db, `rooms/${roomCode}`), { status: "finished", podiumAt: serverTimestamp() }); }
      }
    }
    function approveTeam(id) { if(roomCode && roomStatus === "lobby") update(ref(db, `rooms/${roomCode}/teams/${id}`), { approved: true, lives: 3, status: "lobby" }); }
    async function assignFinishRankIfNeeded(t) {
      if(!roomCode || t.finishRank) return;
      if((t.progress||0) < TOTAL_QUESTIONS) return;
      const tx = await runTransaction(ref(db, `rooms/${roomCode}/nextFinishRank`), (c) => (c||1) + 1);
      const rank = Math.max(1, (tx.snapshot.val()||2) - 1);
      await update(ref(db, `rooms/${roomCode}/teams/${t.id}`), { finishRank: rank, finishedAt: serverTimestamp() });
    }
    function showPodiumFromTeams(obj) {
      const all = Object.values(obj||{}).filter(t=>t.approved && t.finishRank).sort((a,b)=>a.finishRank - b.finishRank);
      if(all.length===0) return;
      const t1 = all.find(t=>t.finishRank===1); const t2 = all.find(t=>t.finishRank===2); const t3 = all.find(t=>t.finishRank===3);
      const fill = (elT, elM, t) => { if(t){ elT.textContent=t.teamName; elM.textContent=(t.members||[]).join(", "); } else { elT.textContent="‚Äî"; elM.textContent=""; } };
      fill(els.p1Team, els.p1Members, t1); fill(els.p2Team, els.p2Members, t2); fill(els.p3Team, els.p3Members, t3);
      els.podiumSub.textContent = `Total Aprobados: ${Object.values(obj).filter(t=>t.approved).length}`;
      els.podiumModal.style.display = "flex";
    }
    function generateRoomCode() { const c="ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; let r=""; for(let i=0;i<6;i++) r+=c.charAt(Math.floor(Math.random()*c.length)); return r; }
    function clampInt(n,min,max){ return Math.min(max, Math.max(min, Number(n)||0)); }
    function escapeHtml(s){ return String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
  </script>
</body>
</html>
